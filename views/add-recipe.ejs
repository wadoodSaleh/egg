<!DOCTYPE html>
<%- include('parts/header', { pageName: locals.isEdit ? 'Edit Recipe' : 'Add Recipe' , pageTitle: locals.isEdit
    ? 'Edit Recipe' : 'Add Recipe' , bodyClass: 'body_leaderboard' }) %>

    <div class="panel-container" style="max-width: 600px;">
        <div class="panel-inner">
            <h1 class="panel-title">
                <%= locals.isEdit ? 'Edit Recipe' : 'New Recipe' %>
            </h1>

            <% if (locals.error) { %>
                <div
                    style="background: #FFE5F0; color: #EC8784; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px; border: 3px solid #EC8784; font-weight: bold; text-transform: uppercase;">
                    <%= error %>
                </div>
                <% } %>



                    <form action="<%= locals.isEdit ? '/recipes/' + recipe.slug + '?_method=PUT' : '/recipes' %>"
                        method="POST" enctype="multipart/form-data" class="add-recipe-form">

                        <div class="form-group">
                            <label for="name">Recipe Name</label>
                            <input type="text" id="name" name="name" required placeholder="e.g. Grandma's Secret Egg"
                                value="<%= locals.recipe ? recipe.name : '' %>">
                        </div>

                        <div class="form-group">
                            <label for="ingredients">Ingredients (one per line)</label>
                            <textarea id="ingredients" name="ingredients" rows="5" required
                                placeholder="1 egg&#10;Salt&#10;Pepper"><%= locals.recipe && recipe.ingredients ? (Array.isArray(recipe.ingredients) ? recipe.ingredients.join('\n') : JSON.parse(recipe.ingredients).join('\n')) : '' %></textarea>
                        </div>

                        <div class="form-group">
                            <label for="instructions">Instructions (one per line)</label>
                            <textarea id="instructions" name="instructions" rows="5" required
                                placeholder="Crack egg.&#10;Cook egg.&#10;Eat egg."><%= locals.recipe && recipe.instructions ? (Array.isArray(recipe.instructions) ? recipe.instructions.join('\n') : JSON.parse(recipe.instructions).join('\n')) : '' %></textarea>
                        </div>

                        <div class="form-group">
                            <label for="winning_minute">Cook Time (minutes)</label>
                            <input type="number" id="winning_minute" name="winning_minute" step="0.1"
                                value="<%= locals.recipe ? recipe.winning_minute : '0.5' %>" min="0.1" required>
                            <small style="color: grey;">Time to perfectly cook the egg (e.g. 1.5, 0.5)</small>
                        </div>

                        <div class="form-group">
                            <label for="losing_minute">Burn Time (minutes)</label>
                            <input type="number" id="losing_minute" name="losing_minute" step="0.1"
                                value="<%= locals.recipe ? recipe.losing_minute : '1' %>" min="0.1" required>
                        </div>

                        <div class="form-group">
                            <label>Image Source</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="imageSource" value="default" <%=(!locals.recipe ||
                                        (recipe.image_path && !recipe.image_path.startsWith('/uploads/'))) ? 'checked'
                                        : '' %>
                                    onchange="toggleImageInput()"> Default
                                </label>
                                <label>
                                    <input type="radio" name="imageSource" value="upload" <%=(locals.recipe &&
                                        recipe.image_path && recipe.image_path.startsWith('/uploads/')) ? 'checked' : ''
                                        %> onchange="toggleImageInput()">
                                    Upload
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="defaultImageGroup">
                            <label for="defaultImage">Select Image</label>
                            <select id="defaultImage" name="defaultImage">
                                <option value="/boiled.png" <%=(locals.recipe && recipe.image_path==='/boiled.png' )
                                    ? 'selected' : '' %>>Boiled Egg</option>
                                <option value="/sunnysideup.png" <%=(locals.recipe &&
                                    recipe.image_path==='/sunnysideup.png' ) ? 'selected' : '' %>>Sunny Side Up
                                </option>
                                <option value="/omelet.png" <%=(locals.recipe && recipe.image_path==='/omelet.png' )
                                    ? 'selected' : '' %>>Omelet</option>
                                <option value="/scrumbeled.png" <%=(locals.recipe &&
                                    recipe.image_path==='/scrumbeled.png' ) ? 'selected' : '' %>>Scrambled</option>
                            </select>
                        </div>

                        <div class="form-group" id="uploadImageGroup" style="display: none;">
                            <label for="uploadImage">Upload Image (Max 2MB)</label>
                            <% if (locals.recipe && recipe.image_path && recipe.image_path.startsWith('/uploads/')) { %>
                                <div style="margin-bottom: 10px;">
                                    <img src="<%= recipe.image_path %>" style="max-height: 100px; display: block;">
                                    <small>Current Image (Upload new to replace)</small>
                                </div>
                                <% } %>
                                    <input type="file" id="uploadImage" name="uploadImage" accept="image/*">
                        </div>

                        <div class="form-group">
                            <label for="animation">Timer Animation</label>
                            <select id="animation" name="animation">
                                <option value="boiling_egg.html" <%=(locals.recipe &&
                                    recipe.animation==='boiling_egg.html' ) ? 'selected' : '' %>>Boiling Water
                                </option>
                                <option value="sunny_side_up_egg.html" <%=(locals.recipe &&
                                    recipe.animation==='sunny_side_up_egg.html' ) ? 'selected' : '' %>>Frying Pan
                                </option>
                                <option value="omelet.html" <%=(locals.recipe && recipe.animation==='omelet.html' )
                                    ? 'selected' : '' %>>Omelet Pan</option>
                                <option value="scrambled_eggs.html" <%=(locals.recipe &&
                                    recipe.animation==='scrambled_eggs.html' ) ? 'selected' : '' %>>Scrambling Pan
                                </option>
                            </select>
                        </div>

                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" name="is_shared" value="true" <%=(locals.recipe &&
                                    (recipe.is_shared===1 || recipe.is_shared===true)) ? 'checked' : '' %>> Share
                                with others?
                            </label>
                        </div>

                        <button type="submit" class="submit-btn" style="margin-top: 20px;">
                            <%= locals.isEdit ? 'Update Recipe' : 'Create Recipe' %>
                        </button>
                    </form>

                    <a href="/dashboard" class="back-btn">Back to Menu</a>
        </div>
    </div>

    <script>
        function toggleImageInput() {
            const source = document.querySelector('input[name="imageSource"]:checked').value;
            const defaultGroup = document.getElementById('defaultImageGroup');
            const uploadGroup = document.getElementById('uploadImageGroup');

            if (source === 'default') {
                defaultGroup.style.display = 'block';
                uploadGroup.style.display = 'none';
            } else {
                defaultGroup.style.display = 'none';
                uploadGroup.style.display = 'block';
            }
        }

        function validateTimers(event) {
            const winningTime = parseFloat(document.getElementById('winning_minute').value);
            const losingTime = parseFloat(document.getElementById('losing_minute').value);

            if (losingTime <= winningTime) {
                event.preventDefault();
                alert('Burn Time must be greater than Cook Time!');
                return false;
            }
            return true;
        }

        // Run on load to set initial state (for edit mode)
        document.addEventListener('DOMContentLoaded', () => {
            toggleImageInput();

            // Attach validation to form
            const form = document.querySelector('.add-recipe-form');
            if (form) {
                form.addEventListener('submit', validateTimers);
            }
        });
    </script>

    <style>
        .add-recipe-form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #EC8784;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 3px solid #EC8784;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            background: white;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(180deg, #F8E769 0%, #f9d948 100%);
            border: 4px solid #EC8784;
            border-radius: 40px;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: #EC8784;
            text-transform: uppercase;
            letter-spacing: 0.2rem;
            cursor: pointer;
            box-shadow: 0 6px 0 #e96b73;
            transition: all 0.15s ease;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #e96b73;
        }

        .submit-btn:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #e96b73;
        }
    </style>

    <%- include('parts/footer') %>